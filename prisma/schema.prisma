// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ========================
// User Model
// ========================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sources         Source[]
  quizzes         Quiz[]
  quizAttempts    QuizAttempt[]
  readingProgress ReadingProgress[]
}

// ========================
// Source Library Models
// ========================

model Source {
  id              String   @id @default(cuid())
  title           String
  author          String?
  coverPath       String?
  filePath        String?  @unique
  fileHash        String?
  fileSize        Int?
  sourceType      String   @default("file") // "file", "youtube", or "web"
  youtubeVideoId  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  userId          String

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapters    Chapter[]
  readingProgress ReadingProgress[]

  @@unique([fileHash, userId])
  @@unique([youtubeVideoId, userId])
  @@map("Book")
}

model Chapter {
  id        String   @id @default(cuid())
  sourceId  String   @map("bookId")
  title     String
  href      String
  order     Int
  parentId  String?

  source    Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  parent    Chapter? @relation("ChapterHierarchy", fields: [parentId], references: [id])
  children  Chapter[] @relation("ChapterHierarchy")
  quiz      Quiz?
}

model ReadingProgress {
  id        String   @id @default(cuid())
  sourceId  String   @map("bookId")
  chapterId String?
  progress  Float    @default(0)
  updatedAt DateTime @updatedAt
  userId    String

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  source    Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([sourceId, userId])
}

// ========================
// Quiz System Models
// ========================

model Quiz {
  id          String   @id @default(cuid())
  title       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  chapterId   String?  @unique
  userId      String

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions   Question[]
  attempts    QuizAttempt[]
  chapter     Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)
}

model Question {
  id             String   @id @default(cuid())
  quizId         String
  externalId     String   // ID from JSON
  text           String
  quote          String?
  type           String   // "single" or "multiple"
  order          Int
  correctAnswers String   // JSON array of correct option IDs
  
  quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options        Option[]
}

model Option {
  id          String   @id @default(cuid())
  questionId  String
  externalId  String   // ID from JSON
  text        String
  explanation String
  order       Int
  
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id           String   @id @default(cuid())
  quizId       String
  score        Int
  totalQuestions Int
  completedAt  DateTime @default(now())
  userId       String

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz         Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers      AttemptAnswer[]
}

model AttemptAnswer {
  id          String   @id @default(cuid())
  attemptId   String
  questionId  String
  selectedIds String   // JSON array of selected option IDs
  isCorrect   Boolean
  
  attempt     QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
}
